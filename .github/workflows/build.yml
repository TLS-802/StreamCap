name: Build Application

on:
  push:
    branches: [ main, master ]
    paths:
      - 'app/**'
      - 'assets/**'
      - 'config/**'
      - 'locales/**'
      - 'main.py'
      - 'pyproject.toml'
      - 'requirements.txt'
      - '.github/workflows/build.yml'
  workflow_dispatch:

# 添加权限配置
permissions:
  contents: write
  actions: write

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Get version from pyproject.toml
        id: get-version
        run: |
          VERSION=$(grep -m 1 'version = ' pyproject.toml | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

  build-windows:
    needs: extract-version
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Download FFmpeg for Windows
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "."
          Move-Item -Path "ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" -Destination "."
          Move-Item -Path "ffmpeg-master-latest-win64-gpl\bin\ffprobe.exe" -Destination "."
      
      - name: Create default config files
        run: |
          # 确保config目录存在所需的默认配置文件
          if (!(Test-Path "config/user_settings.json")) {
            Copy-Item "config/default_settings.json" -Destination "config/user_settings.json"
          }
          if (!(Test-Path "config/accounts.json")) {
            echo "{}" | Out-File -FilePath "config/accounts.json" -Encoding utf8
          }
          if (!(Test-Path "config/recordings.json")) {
            echo "[]" | Out-File -FilePath "config/recordings.json" -Encoding utf8
          }
          if (!(Test-Path "config/cookies.json")) {
            echo "{}" | Out-File -FilePath "config/cookies.json" -Encoding utf8
          }
          
          # 创建.env文件，设置PLATFORM环境变量
          echo "PLATFORM=desktop" | Out-File -FilePath ".env" -Encoding utf8
      
      - name: Build with PyInstaller
        run: |
          # 使用--noconsole替代--windowed，避免双窗口问题
          pyinstaller --name=StreamCap --icon=assets/icon.ico --noconsole --noconfirm --add-data="assets;assets" --add-data="config;config" --add-data="locales;locales" --add-data=".env;." --add-data="ffmpeg.exe;." --add-data="ffprobe.exe;." main.py
      
      - name: Create ZIP archive
        run: |
          cd dist
          Compress-Archive -Path StreamCap -DestinationPath "StreamCap-${{ needs.extract-version.outputs.version }}-win.zip"
      
      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: StreamCap-Windows
          path: dist/StreamCap-${{ needs.extract-version.outputs.version }}-win.zip
          retention-days: 1
  
  build-macos:
    needs: extract-version
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow
      
      - name: Download FFmpeg for macOS
        run: |
          brew install ffmpeg
          mkdir -p ffmpeg
          cp $(which ffmpeg) ffmpeg/
          cp $(which ffprobe) ffmpeg/
      
      - name: Create default config files
        run: |
          # 确保config目录存在所需的默认配置文件
          if [ ! -f "config/user_settings.json" ]; then
            cp config/default_settings.json config/user_settings.json
          fi
          if [ ! -f "config/accounts.json" ]; then
            echo "{}" > config/accounts.json
          fi
          if [ ! -f "config/recordings.json" ]; then
            echo "[]" > config/recordings.json
          fi
          if [ ! -f "config/cookies.json" ]; then
            echo "{}" > config/cookies.json
          fi
          
          # 创建.env文件，设置PLATFORM环境变量
          echo "PLATFORM=desktop" > .env
      
      - name: Create ICNS icon
        run: |
          # 创建临时图标目录
          mkdir -p icon.iconset
          
          # 创建一个临时PNG图标文件
          python -c "
          from PIL import Image
          import os
          # 尝试打开ICO文件
          try:
              img = Image.open('assets/icon.ico')
              img.save('temp_icon.png')
              print('成功转换ICO到PNG')
          except Exception as e:
              print(f'转换失败: {e}')
              # 创建一个简单的默认图标
              img = Image.new('RGB', (512, 512), color=(66, 91, 255))
              img.save('temp_icon.png')
              print('创建了默认图标')
          "
          
          # 使用sips工具创建多种尺寸的PNG
          sips -z 16 16 temp_icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32 temp_icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64 temp_icon.png --out icon.iconset/icon_64x64.png
          sips -z 128 128 temp_icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256 temp_icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512 temp_icon.png --out icon.iconset/icon_512x512.png
          
          # 创建ICNS文件
          iconutil -c icns icon.iconset -o Appicon.icns
          
          # 显示生成的图标文件
          ls -la Appicon.icns
      
      - name: Create Info.plist
        run: |
          cat > Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDisplayName</key>
              <string>StreamCap</string>
              <key>CFBundleExecutable</key>
              <string>StreamCap</string>
              <key>CFBundleIconFile</key>
              <string>Appicon.icns</string>
              <key>CFBundleIdentifier</key>
              <string>io.github.ihmily.streamcap</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>StreamCap</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ needs.extract-version.outputs.version }}</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSEnvironment</key>
              <dict>
                  <key>PLATFORM</key>
                  <string>desktop</string>
              </dict>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
              <key>NSRequiresAquaSystemAppearance</key>
              <false/>
          </dict>
          </plist>
          EOF
      
      - name: Build macOS App with PyInstaller
        run: |
          # PyInstaller将创建.app包。
          # 我们使用 --onedir 和 --noconsole，并提供所有数据文件和图标。
          # PyInstaller会将数据文件放置在Contents/MacOS中，与可执行文件放在一起。
          pyinstaller --name "StreamCap" \
            --noconsole \
            --onedir \
            --icon "Appicon.icns" \
            --add-data "assets:assets" \
            --add-data "config:config" \
            --add-data "locales:locales" \
            --add-data "ffmpeg:ffmpeg" \
            --add-data ".env:." \
            --noconfirm \
            --clean \
            main.py
          
          # PyInstaller会创建一个默认的Info.plist。我们用自定义的那个替换它。
          cp Info.plist dist/StreamCap.app/Contents/
          
          # 为了调试目的，列出生成的应用程序的结构
          echo "--- Contents of StreamCap.app ---"
          ls -lR dist/StreamCap.app
          echo "---------------------------------"
      
      - name: Create DMG
        run: |
          pip install dmgbuild
          
          # 创建dmg_settings.py文件在dist目录
          cat > dist/dmg_settings.py << 'EOF'
          # DMG Settings for macOS package
          import os
          
          # Volume format (see hdiutil create -help)
          format = 'UDBZ'
          
          # Volume size
          size = None
          
          # Files to include
          files = ['StreamCap.app']
          
          # Symlinks to create
          symlinks = {'Applications': '/Applications'}
          
          # Where to put the icons
          icon_locations = {
              'StreamCap.app': (140, 120),
              'Applications': (500, 120)
          }
          
          # Window configuration
          window_rect = ((100, 100), (640, 300))
          
          # Background
          background = 'builtin-arrow'
          EOF
          
          cd dist
          dmgbuild -s dmg_settings.py "StreamCap" "StreamCap-${{ needs.extract-version.outputs.version }}-mac.dmg"
      
      - name: Upload macOS build artifact
        uses: actions/upload-artifact@v4
        with:
          name: StreamCap-macOS
          path: dist/StreamCap-${{ needs.extract-version.outputs.version }}-mac.dmg
          retention-days: 1
  
  create-release:
    needs: [extract-version, build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check if tag exists
        id: check-tag
        run: |
          VERSION=${{ needs.extract-version.outputs.version }}
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag v$VERSION already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag v$VERSION does not exist"
          fi
        
      - name: Create Tag
        if: steps.check-tag.outputs.exists == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a v${{ needs.extract-version.outputs.version }} -m "Release v${{ needs.extract-version.outputs.version }}"
          git push origin v${{ needs.extract-version.outputs.version }}
      
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: StreamCap-Windows
          path: dist
      
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: StreamCap-macOS
          path: dist
      
      - name: List artifacts
        run: ls -la dist/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.extract-version.outputs.version }}
          name: StreamCap v${{ needs.extract-version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            dist/StreamCap-${{ needs.extract-version.outputs.version }}-win.zip
            dist/StreamCap-${{ needs.extract-version.outputs.version }}-mac.dmg
          body: |
            # StreamCap v${{ needs.extract-version.outputs.version }}
            
            ## 新版本发布
            
            ### 安装包下载
            - [Windows 版本](https://github.com/${{ github.repository }}/releases/download/v${{ needs.extract-version.outputs.version }}/StreamCap-${{ needs.extract-version.outputs.version }}-win.zip)
            - [macOS 版本](https://github.com/${{ github.repository }}/releases/download/v${{ needs.extract-version.outputs.version }}/StreamCap-${{ needs.extract-version.outputs.version }}-mac.dmg)
            
            ### 安装说明
            - Windows: 下载并解压ZIP文件，运行StreamCap.exe
            - macOS: 下载DMG文件，打开并将应用拖动到应用程序文件夹
            
            ### 使用方法
            请参考[使用文档](https://github.com/ihmily/StreamCap/wiki) 
