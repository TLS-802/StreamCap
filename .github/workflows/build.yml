name: Build Application

on:
  push:
    branches: [ main, master ]
    paths:
      - 'app/**'
      - 'assets/**'
      - 'config/**'
      - 'locales/**'
      - 'main.py'
      - 'pyproject.toml'
      - 'requirements.txt'
      - '.github/workflows/build.yml'
  workflow_dispatch:

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Get version from pyproject.toml
        id: get-version
        run: |
          VERSION=$(grep -m 1 'version = ' pyproject.toml | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

  build-windows:
    needs: extract-version
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Download FFmpeg for Windows
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "."
          Move-Item -Path "ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" -Destination "."
          Move-Item -Path "ffmpeg-master-latest-win64-gpl\bin\ffprobe.exe" -Destination "."
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --name=StreamCap --icon=assets/icon.ico --windowed --noconfirm --add-data="assets;assets" --add-data="config;config" --add-data="locales;locales" --add-data="ffmpeg.exe;." --add-data="ffprobe.exe;." main.py
      
      - name: Create ZIP archive
        run: |
          cd dist
          Compress-Archive -Path StreamCap -DestinationPath "StreamCap-${{ needs.extract-version.outputs.version }}-win.zip"
      
      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: StreamCap-Windows
          path: dist/StreamCap-${{ needs.extract-version.outputs.version }}-win.zip
  
  build-macos:
    needs: extract-version
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow
      
      - name: Download FFmpeg for macOS
        run: |
          brew install ffmpeg
          mkdir -p ffmpeg
          cp $(which ffmpeg) ffmpeg/
          cp $(which ffprobe) ffmpeg/
      
      - name: Create ICNS icon
        run: |
          # 创建临时图标目录
          mkdir -p icon.iconset
          
          # 创建一个临时PNG图标文件
          python -c "
          from PIL import Image
          import os
          # 尝试打开ICO文件
          try:
              img = Image.open('assets/icon.ico')
              img.save('temp_icon.png')
              print('成功转换ICO到PNG')
          except Exception as e:
              print(f'转换失败: {e}')
              # 创建一个简单的默认图标
              img = Image.new('RGB', (512, 512), color=(66, 91, 255))
              img.save('temp_icon.png')
              print('创建了默认图标')
          "
          
          # 使用sips工具创建多种尺寸的PNG
          sips -z 16 16 temp_icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32 temp_icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64 temp_icon.png --out icon.iconset/icon_64x64.png
          sips -z 128 128 temp_icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256 temp_icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512 temp_icon.png --out icon.iconset/icon_512x512.png
          
          # 创建ICNS文件
          iconutil -c icns icon.iconset -o StreamCap.icns
          
          # 显示生成的图标文件
          ls -la StreamCap.icns
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --name=StreamCap --icon=StreamCap.icns --windowed --noconfirm --add-data="assets:assets" --add-data="config:config" --add-data="locales:locales" --add-data="ffmpeg:ffmpeg" main.py
      
      - name: Create DMG
        run: |
          pip install dmgbuild
          
          # 创建dmg_settings.py文件在dist目录
          cat > dist/dmg_settings.py << 'EOF'
          # DMG Settings for macOS package
          import os
          
          # Volume format (see hdiutil create -help)
          format = 'UDBZ'
          
          # Volume size
          size = None
          
          # Files to include
          files = ['StreamCap.app']
          
          # Symlinks to create
          symlinks = {'Applications': '/Applications'}
          
          # Where to put the icons
          icon_locations = {
              'StreamCap.app': (140, 120),
              'Applications': (500, 120)
          }
          
          # Window configuration
          window_rect = ((100, 100), (640, 300))
          
          # Background
          background = 'builtin-arrow'
          EOF
          
          cd dist
          dmgbuild -s dmg_settings.py "StreamCap" "StreamCap-${{ needs.extract-version.outputs.version }}-mac.dmg"
      
      - name: Upload macOS build artifact
        uses: actions/upload-artifact@v4
        with:
          name: StreamCap-macOS
          path: dist/StreamCap-${{ needs.extract-version.outputs.version }}-mac.dmg
  
  create-tag:
    needs: [extract-version, build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Create Tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a v${{ needs.extract-version.outputs.version }} -m "Release v${{ needs.extract-version.outputs.version }}"
          git push origin v${{ needs.extract-version.outputs.version }} 
